---
title: "ABC Bank Customer Churn"
author: "T4"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---
```{r init, include=FALSE}
library(ezids)
loadPkg("Hmisc") 
library(dplyr)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
```

# EDA

**Reading the file with all the customer churn details as a data frame.Then displaying the structure of the data frame**

```{r Churn_data_file, include=T,echo=TRUE,results="rpois"}
churn_data<-data.frame(read.csv("Bank_Customer_Churn_Prediction.csv",header=TRUE))
str(churn_data)
```
The churn data frame as `r nrow(churn_data)` observations with `r ncol(churn_data)` variables.


**Checking for duplicates in the data frame.**
```{r duplicates}
nrow(unique(churn_data))
```

There are `r nrow(unique(churn_data))` rows of unique records in the data.Hence we the data frame has no duplicates records.We can proceed with next step of analysis.


**Checking for summary of the churn data frame.**

```{r churn_summary,results='apois'}
summary(churn_data)
```

## Independent variable EDA

**Converting required variables into categorical values**
```{r category}
str(churn_data)
churn_data_category=churn_data
churn_data_category$credit_card=factor(churn_data$credit_card)
churn_data_category$active_member=factor(churn_data$active_member)
churn_data_category$churn=factor(churn_data$churn)
churn_data_category$gender=factor(churn_data$gender)
churn_data_category$tenure =factor(churn_data$tenure )
churn_data_category$products_number=factor(churn_data$products_number)
str(churn_data_category)
```

```{r Checking for NA}

```


We decided to convert these variables into categorical (factor):  
`credit_card`, `active_member`, `churn` and `gender`. Notice that 
the data frame `churn_data` still has all variables numerical, while the data frame `churn_data_category` 
include categorical columns that we just converted. 

**Converting Boolean values into Character format**
```{r}
churn_data$active_member[churn_data$active_member== 1]<-"Active"
churn_data$active_member[churn_data$active_member== 0]<-"In Active"

churn_data$credit_card[churn_data$credit_card== 1]<-"Credit Card"
churn_data$credit_card[churn_data$credit_card== 0]<-"No-Credit Card"

churn_data$churn[churn_data$churn== 1]<-"Churned"
churn_data$churn[churn_data$churn== 0]<-"Retained"

```

### Ouliers For Customer data

***Checking for outliers in the data frame  for credit_score,age,tenure,balance,estimated_salary variables  using outlierKD function.***

```{r customer_credit_score}
credit_score_clean <- outlierKD2(churn_data, credit_score, rm = TRUE, boxplt = TRUE, qqplt = TRUE)
xkablesummary(credit_score_clean)
```
```{r Check for NA in the dataframe}
sum(is.na(churn_data) == 'TRUE')
```


The proportion outliers for credit_card variable if 0.2% and it was removed successfully using outlierKD function.


```{r customer_age}
age_clean <- outlierKD2(churn_data, age, rm = TRUE, boxplt = TRUE, qqplt = TRUE)
xkablesummary(age_clean)
```

```{r Cutomer_tenure}
tenure_clean <- outlierKD2(churn_data, tenure, rm = TRUE, boxplt = TRUE, qqplt = TRUE)
xkablesummary(tenure_clean)
```


```{r balance}
balance_clean <- outlierKD2(churn_data, balance, rm = TRUE, boxplt = TRUE, qqplt = TRUE)
xkablesummary(balance_clean)
```


```{r estimated_salary}
salary_clean <- outlierKD2(churn_data, estimated_salary, rm = TRUE, boxplt = TRUE, qqplt = TRUE)
xkablesummary(salary_clean)
```
By using outlierKD function we can observe that outliers where found only in `age` and `credit_card` variables i.e,3.7% and 0.2%

### Customer Analysis 

```{r Credit_score}

library(ggplot2)
ggplot(data=churn_data, aes(x=credit_score)) + 
  geom_histogram(col="black",bins=30,
                 fill="dark orange", 
                  alpha =.7) + # opacity
  labs(title="`ggplot`") +
  labs(title="Customer's Credit Scores",x="Credit_Score", y="Customer Count") 
print(mean(churn_data$credit_score))
print(sd(churn_data$credit_score))

```

**The average `credit score` of the customer is `r mean(churn_data$credit_score)`,most of the customer having credit score fall between 600 to 700 and standard deviation is `r sd(churn_data$credit_score)`.**


```{r Country}
ggplot(data=churn_data,aes(x=country,fill=country))+
  geom_bar(col="black")+
  scale_fill_brewer(palette="Reds") +
  labs(title = "Bank Cusomter vs Country",x="Country",y="Customer Count")+
  theme_minimal()

```

**The customers are grouped by the countries in which they have their accounts.As we see from the plot France has more than 50% of customer account which is the highest among all other countries.**

```{r Age}
ggplot(churn_data, aes(x = age,fill=cut(age,100))) + 
  geom_histogram(show.legend = FALSE,col="black",bins=30)+
  scale_fill_discrete(h=c(240,10),c=120,l=70)+
  theme_minimal()+
  labs(x=" Customer Age",y=" Customer Count")+
  ggtitle("Customer ages")
print(mean(churn_data$age))
print(sd(churn_data$age))
```
**The majority of the bank customer's fall below the age of 30 with average age of `r mean(churn_data$age)` and with standard deviation of `r sd(churn_data$age)`.**

```{r tenure}

library(ggplot2)
ggplot(data=churn_data, aes(x=tenure)) + 
  geom_histogram(col="black",bins=11,
                 fill="Yellow", 
                  alpha =.7) + 
  labs(title="Years spent as customer",x="Number of years", y="Customer Count") 

```

**Most of the customer as been with bank for more than a year.**

```{r Gender}
df <- churn_data %>% 
  group_by(gender) %>% # Variable to be transformed
  count() %>% 
  ungroup() %>% 
  mutate(perc = `n` / sum(`n`)) %>% 
  arrange(perc) %>%
  mutate(labels = scales::percent(perc))
str(df)

ggplot(df, aes(x = "", y = perc, fill = gender)) +
  geom_col(color="black") +
  geom_text(aes(label = labels),color = c("black", "black"),
            position = position_stack(vjust = 0.5)) +
  coord_polar(theta = "y")+
  labs(title="Percentage of Male and Female customers in bank",x="", y="") 
```  
**The Male customers are highest in percent of 55% and remaining 45% are Female customers.**

```{r Active_Memebers}

df <- churn_data %>% 
  group_by(active_member) %>% # Variable to be transformed
  count() %>% 
  ungroup() %>% 
  mutate(perc = `n` / sum(`n`)) %>% 
  arrange(perc) %>%
  mutate(labels = scales::percent(perc))
str(df)


ggplot(df, aes(x = "", y = perc, fill = active_member)) +
  geom_col(color="black") +
  geom_label(aes(label = labels),color = c("black", "white"),
             position = position_stack(vjust = 0.5),
             show.legend = FALSE) +
  coord_polar(theta = "y")+
  scale_fill_grey()+
  labs(title="Percentage of active members in bank",x="", y="") 
```  
**We can see that 48% of the customers accounts are inactive**

```{r Credit_Card}
df <- churn_data %>% 
  group_by(credit_card) %>% # Variable to be transformed
  count() %>% 
  ungroup() %>% 
  mutate(perc = `n` / sum(`n`)) %>% 
  arrange(perc) %>%
  mutate(labels = scales::percent(perc))
str(df)

ggplot(df, aes(x = "", y = perc, fill = credit_card)) +
  geom_col(color="black") +
  geom_label(aes(label = labels),color = c("black", "black"),
             position = position_stack(vjust = 0.5),
             show.legend = FALSE) +
  coord_polar(theta = "y")+
  scale_fill_brewer(palette="Greens")
  labs(title="Percentage of customer use credit card",x="", y="") 
```  
**Predominantly 71% of the Bank customer use credit_card and only 29% do not make use of it.**

```{r Products}
df <- churn_data %>% 
  group_by(products_number) %>% # Variable to be transformed
  count() %>% 
  ungroup() %>% 
  mutate(perc = `n` / sum(`n`)) %>% 
  arrange(perc) %>%
  mutate(labels = scales::percent(perc))
str(df)

ggplot(df, aes(x = "", y = perc, fill = products_number)) +
  geom_col(color="black") +
  geom_label(aes(label = labels),color = c("white", "white","white","white"),
             position = position_stack(vjust = 0.5),
             show.legend = FALSE) +
  coord_polar(theta = "y")+
  labs(title="Percentage of  different products used by customers ",x="", y="") 
  
``` 
**Most of the customer user product 1 which is 50% and product 4 is the least used with 0.6%.**


```{r Customer_churn}
df <- churn_data %>% 
  group_by(churn) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(perc = `n` / sum(`n`)) %>% 
  arrange(perc) %>%
  mutate(labels = scales::percent(perc))
str(df)

ggplot(df, aes(x = "", y = perc, fill = churn)) +
  geom_col(color="black") +
  geom_label(aes(label = labels),color = c("black", "black"),
             position = position_stack(vjust = 0.5),
             show.legend = FALSE) +
  coord_polar(theta = "y")+
  scale_fill_brewer(palette="Purples")+
  labs(title="Percentage of customer retained",x="", y="") 
```  

**The bank managed to retain 80% of their customers with the remaining 20% where churned out.**

### Churned Customer Analysis

#### SMART Questions:
```{r credit card-churn}
churn_data[, 11:12][churn_data[, 11:12] == 1] <- 'Churn'
churn_data[, 11:12][churn_data[, 11:12] == 0] <- 'No Churn'

cc_churn <- table(churn_data$churn, churn_data$credit_card)
cc_churn

chitestccchurn <- chisq.test(cc_churn)
chitestccchurn
```
Credit Card vs Churn
P-value of 0.5 is much higher that the significance level (0.05 for df=1). Thus, we reject the null hypothesis, as there is a 0.5 or 50% chance of these results occuring by chance. We can conclude that there is no relationship between whether a user has a credit card, and churn.







```{r country}

```
